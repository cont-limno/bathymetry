---
title: "LAGOS lake depth"
output: pdf_document
---

```{r setup, include=FALSE}
source("scripts/99_utils.R")
knitr::opts_chunk$set(echo = FALSE, eval = FALSE, message = FALSE, 
                      warning = FALSE,
                      fig.path = "figures/", fig.width = 5, fig.height = 6,
                      dev = c("pdf"))
```

```{r data, message=FALSE, echo=FALSE, eval=TRUE}
dt <- read.csv("data/lagosus_depth.csv", stringsAsFactors = FALSE) %>%
  mutate(max_depth_m_class = cut(max_depth_m, 
                     round(quantile(max_depth_m, c(0, 0.05, 0.5, 0.95, 1), 
                                    na.rm = TRUE)))) %>% 
    mutate(area_class =
           smart_cut(lake_waterarea_ha, c(1, 4, 40, 80, 400,
                                                          1000, 20000, Inf),
             labels = ~paste(sep="-", thousand_k(.y[1]), thousand_k(.y[2])))
         ) %>%
  coordinatize(latname = "lat", longname = "long")

hypso_ct <- read.csv("data/ct_hypso.csv", stringsAsFactors = FALSE) %>%
  select(-n) %>% group_by(id) %>%  add_tally() %>% ungroup() %>%
  dplyr::filter(n > 3) %>%
  filter(!str_detect(id, "Cove"))
hypso_mn <- read.csv("data/mn_hypso.csv", stringsAsFactors = FALSE)
```

```{r map, echo=FALSE, message=FALSE, error = FALSE, eval=TRUE}
states_base <- jsta::get_intersects(jsta::usa_sf(), dt, 
                                    threshold = 1)

ggplot() + 
  geom_sf(data = states_base) +
  geom_sf(data = dplyr::sample_frac(
    dplyr::filter(dt, !is.na(max_depth_m)), 0.3), 
          aes(color = max_depth_m_class), 
    size = 1, alpha = 0.4, shape = 20) +
  # scale_color_viridis_d(direction = -1) +
  # scale_color_brewer(palette = "Set2") +
  scale_fill_brewer(palette = "Set2") +
  coord_sf(datum = NA) + theme_void() +
  labs(color = "max depth (m)")
```

```{r summary_stats, echo = FALSE, eval=TRUE}
lg <- lagosne_load("1.087.3")

dt_plot <- dplyr::bind_rows(
   read.csv("data/00_manual/00_manual.csv", stringsAsFactors = FALSE))

paste0(round(sum(!is.na(dt_plot$max_depth_m)) / nrow(dt_plot) * 100, 2),
       "% (n=", sum(!is.na(dt_plot$max_depth_m)), ") of lakes with limno data in lagosus have max_depth_m values.")

dt_plot <- dplyr::bind_rows(
   read.csv("data/00_lagosne/00_lagosne.csv", stringsAsFactors = FALSE)) %>% 
  mutate(has_limno = llid %in% lg$epi_nutr$lagoslakeid)

paste0(round(sum(!is.na(dplyr::filter(dt_plot, has_limno)$max_depth_m)) / 
  length(unique(lg$epi_nutr$lagoslakeid)) * 100, 2), 
  "% (n=", sum(!is.na(dplyr::filter(dt_plot, has_limno)$max_depth_m)), ") of lakes with limno data in lagosne have max_depth_m values.")
```

```{r viz, echo=FALSE, warning=FALSE, message=FALSE, fig.height=3, eval=FALSE}
knitr::kable(t(quantile(dt$max_depth_m, c(0, 0.05, 0.5, 0.95, 1), 
                        na.rm = TRUE)), caption = "Lake depth quantiles")
knitr::kable(round(t(quantile(dt$lake_waterarea_ha, c(0, 0.05, 0.5, 0.95, 1), 
                        na.rm = TRUE)), 2), caption = "Lake area quantiles")
```

## Number of lakes with max/mean depth by state

```{r num_lakes, eval = TRUE, echo=FALSE, message=FALSE}
dt_plot <- dt %>%
  st_drop_geometry() %>%
  dplyr::filter(!is.na(max_depth_m)) %>%
  group_by(state) %>%
  tally() %>%
  mutate(n_class = smart_cut(.$n, 5, "groups", 
                        labels = ~paste(sep = "-", round(.y[1]), round(.y[2])))) %>%
  right_join(usa_sf()) %>%
  st_set_geometry("geometry")

ggplot() + 
  geom_sf(data = dt_plot, aes(fill = n_class)) +
  labs(fill = "") +
  ggtitle("Number of lakes with max depth")
```

```{r num-lakes-mean, eval=TRUE}
dt_plot <- dt %>%
  st_drop_geometry() %>%
  dplyr::filter(!is.na(mean_depth_m)) %>%
  group_by(state) %>%
  tally() %>%
  mutate(n_class = smart_cut(.$n, 5, "groups", 
                        labels = ~paste(sep = "-", round(.y[1]), round(.y[2])))) %>%
  right_join(usa_sf()) %>%
  st_set_geometry("geometry")

ggplot() + 
  geom_sf(data = dt_plot, aes(fill = n_class)) +
  labs(fill = "") +
  ggtitle("Number of lakes with mean depth")
```

\newpage 

## What are reasonable cutoffs for depth prediction efforts?

> Oliver used 4 ha < max_depth < 1000 ha

```{r cutoffs, eval = TRUE, echo=FALSE, fig.height = 4}
 
 dt_plot <- dplyr::bind_rows(
   read.csv("data/00_manual/00_manual.csv", stringsAsFactors = FALSE), 
   read.csv("data/00_lagosne/00_lagosne.csv", stringsAsFactors = FALSE)) %>%
  mutate(area_class =
           smart_cut(lake_waterarea_ha, c(1, 4, 40, 80, 400,
                                                          1000, 20000, Inf),
             labels = ~paste(sep="-", thousand_k(.y[1]), thousand_k(.y[2])))
         ) %>%
  drop_na(area_class) %>%
  group_by(area_class) %>%
  mutate(prop_maxdepth = round(mean(!is.na(max_depth_m)), 2)) %>%
  add_tally() %>%
  distinct(area_class, prop_maxdepth, n) %>%
  arrange(area_class)

dt_plot %>%
  ggplot() +
  geom_col(aes(y = n, x = area_class)) +
  geom_text(aes(y = n, x = area_class, label = prop_maxdepth),
            vjust = -0.5, size = 4) +
  ylim(0, 100000) + xlab("Area (ha)") +
  ggtitle("Proportion max depth availability by \n lake area class (LAGOSNE and Manual)")
```

```{r hypsography, eval=TRUE, fig.height = 4}
ids <- factor(c("convex", "concave"))
polys <- data.frame(
  id = rep(ids, each = 3),
  x = c(0, 75, 0, 
        25, 100, 100), 
  y = c(75, 0, 0, 
        100, 100, 25))

plot_grid(
ggplot(data = hypso_ct) +
  geom_polygon(data = polys, aes(x = x, y = y, group = id, fill = id), alpha = 0.2) +
  geom_line(aes(x = area_percent, y = depth_percent, group = id)) +
  geom_abline(intercept = -100, slope = 1, color = "red") +
  ylim(c(100, 0)) +
  ylab("Depth (percent)") + xlab("Area (percent)") + 
  ggtitle(paste0("CT", " (", length(unique(hypso_ct$id)), ") lakes")) + 
  theme(legend.position = "bottom"), 
ggplot(data = hypso_mn) +
    geom_line(aes(x = area_percent, y = depth_percent, group = llid)) +
  ylim(c(100, 0)) +
  ylab("Depth (percent)") + xlab("Area (percent)") +
  ggtitle(paste0("MN", " (", length(unique(hypso_mn$llid)), ") lakes")) +
  theme(axis.title.y = element_blank()), 
rel_widths = c(1, 0.7))

```

```{r raster-to-profile-to-hypso, eval=TRUE, fig.height = 4}
# 3 panel figure of a single starting with rayshader, then depth profile, then hypsography

# use plotly::ggplotly to select specific lakes
# dplyr::filter(hypso_ct, id == "lake_saltonstall") # super deep
# "pickerel_lake" # convex
# "long_pond" # concave

rsub1 <- raster::raster("data/ct_bathy/pickerel_lake.tif")
rsub2 <- raster::raster("data/ct_bathy/long_pond.tif")
names(rsub1) <- "layer"
names(rsub2) <- "layer"

cowplot::plot_grid( 
ggplot(data = as.data.frame(rsub1, xy = TRUE)) +
  geom_raster(aes(x = x, y = y, fill = layer)) +
  coord_quickmap() +
  scale_fill_continuous(tran = "reverse") +
  labs(fill = "") + ggtitle("concave") +
  theme_void(),
ggplot(data = as.data.frame(rsub2, xy = TRUE)) +
  geom_raster(aes(x = x, y = y, fill = layer)) +
  coord_quickmap() +
  scale_fill_continuous(tran = "reverse") +
  labs(fill = "") + ggtitle("convex") +
  theme_void()
)
```

```{r get-hypso, eval=TRUE, fig.height = 4}
get_hypso <- function(rsub, id){
  maxdepth <- abs(cellStats(rsub, "max"))

  # calculate area of each class
  rc <- rsub %>%
    as.data.frame() %>%
    group_by(layer) %>% tally() %>%
    tidyr::drop_na(layer) %>%
    arrange(desc(layer)) %>%
    mutate(n_cs = cumsum(n)) %>%
    rename(depth = layer) %>%
    mutate(area_m2 = n_cs * res(rsub)[1] * res(rsub)[2]) %>%
    mutate(area_percent = scales::rescale(area_m2, to = c(0, 100))) %>%
    mutate(depth_percent = scales::rescale(depth, to = c(0, 100))) %>%
    mutate(n_diff = scales::rescale(c(0, diff(n_cs)), 
                                    to = c(0, 100))) %>%
    mutate(radius_percent = 
             rev(scales::rescale(cumsum(sqrt((n * res(rsub)[1] * res(rsub)[2])/ pi)) * 100)))

  rc
}

hypso1 <- get_hypso(rsub1)
hypso1$type <- "concave"
hypso2 <- get_hypso(rsub2)
hypso2$type <- "convex"
hypso <- dplyr::rbind_all(list(hypso1, hypso2))

# par(mfrow = c(1, 2))
# plot(hypso1$radius_percent, hypso1$depth, 
#      ylim = rev(range(hypso1$depth)))
# plot(hypso1$area_percent, hypso1$depth, 
#      ylim = rev(range(hypso1$depth)))

cowplot::plot_grid(
  ggplot(data = hypso, aes(x = radius_percent, y = depth)) +
    geom_point(aes(color = type)) + geom_line(aes(color = type)) +
    xlab("Radius distance (proportion)") + ylab("Depth") +
    ylim(c(max(hypso$depth), 0)) +
    theme(legend.position = "none"), 
  ggplot(data = hypso, aes(x = area_percent, y = depth)) +
    geom_point(aes(color = type)) + geom_line(aes(color = type)) +
    xlab("Area > depth (percent)") + ylab("Depth") +
    ylim(c(max(hypso$depth), 0)),
rel_widths = c(0.6, 1)
)
```

```{r eval=TRUE, fig.height = 4}
cowplot::plot_grid(
  ggplot(data = hypso, aes(x = radius_percent, y = depth_percent)) +
    geom_point(aes(color = type)) + geom_line(aes(color = type)) +
    xlab("Radius distance (percent)") + ylab("Depth (percent)") + ylim(c(100, 0)), 
ggplot(data = hypso, aes(x = area_percent, y = depth_percent)) +
  geom_point(aes(color = type)) + geom_line(aes(color = type)) +
  xlab("Area > depth (percent)") + ylab("Depth (percent)") +
    ylim(c(100, 0))
)

```

```{r ridgeline} 
# Ridgeline plot of lake depth
library(raster)
r <- raster(ncol = 1000, nrow = 1000)
test <- as_Spatial(
  dplyr::sample_frac(dplyr::select(dt, max_depth_m), 0.2))
test <- raster::rasterize(test, r, field = "max_depth_m")
                  
n <- 1000
vals <- 1:n
r <- raster(ncols=36, nrows=18)
n <- 1000
set.seed(123)
x <- runif(n) * 360 - 180
y <- runif(n) * 180 - 90
xy <- cbind(x, y)
p <- data.frame(xy, name=vals)
coordinates(p) <- ~x+y
  
  raster::rasterToPoints() %>%
  as_data_frame() %>%
    dim()
  rename(z = glp00g30) %>%
  mutate(z = ifelse(z < 5000, NA, z)) %>%
  complete(x, y) %>%
  mutate(z = y + z/0.5e6)

test %>%
  ggplot() +
  geom_path(data = map_data("world"), aes(long, lat, group = group), colour = "grey", alpha = 0.1) +
  geom_polygon(data = map_data("world"), aes(long, lat, group = group), fill = "grey", alpha = 0.1) +
  geom_line(aes(x, z, group = y), lwd = 0.2) +
  # st_bbox(jsta::usa_sf())
  coord_quickmap(ylim = c(25, 50),
                 xlim = c(-125, -66)) +
  scale_x_continuous(NULL, NULL) +
  scale_y_continuous(NULL, NULL)
  
```

```{r mean_vs_max, warning=FALSE}
ggplot(data = dt) + 
  geom_point(aes(x = mean_depth_m, y = max_depth_m))
```
 
```{r papers}
knitr::kable(
  data.frame(stringsAsFactors=FALSE,
  lead_author = c("Hollister", "Heathcote", "Oliver", "Sobek", "Emmerton",
                    "Johansson", "Neumann"),
  year = c(2011L, 2015L, 2016L, 2011L, 2007L, 2007L, 1959L),
  location = c("NE/NY Huc", "Boreal Canada", "LAGOSNE", "Sweden",
                 "Canadian Arctic", "Sweden", "Global"),
  lake_numbers = c(133L, 433L, 7347L, 6618L, 81L, 105L, 107L), 
  rmse_m = c(6, 1.8, 7.1, NA, NA, NA, NA)
))
```

```{r akima}
library(gfplot)
library(dplyr)
library(PBSdata)
library(akima)

bath        <- gfplot:::load_bath(utm_zone = 9) %>% 
  filter(depth > 0) %>%
  filter(X < 600) %>% filter(X > 330) %>%
  filter(Y < 5850) %>% filter(Y > 5630)
bath_interp <- akima::interp(
      x = bath$X,
      y = bath$Y,
      z = log(bath$depth),
      extrap = TRUE, linear = TRUE
    )

z   <- reshape2::melt(bath_interp$z)
z$x <- bath_interp$x[z$Var1]
z$y <- bath_interp$y[z$Var2]
z   <- rename(z, X = x, Y = y, akima_depth = value) %>%
      dplyr::select(-Var1, -Var2) %>%
  filter(!is.na(akima_depth)) %>%
  mutate(akima_depth = exp(akima_depth)) %>%
  dplyr::select(x = X, y = Y, akima_depth)
z   <- raster::rasterFromXYZ(z)

# rasterize bath object. See - https://gis.stackexchange.com/a/79074/32531
bath_ras <- rasterize(bath[,1:2], setValues(z, NA), 
                      bath$depth, fun = mean)


par(mfrow = c(1, 2))
plot(bath_ras)
plot(z)
```
