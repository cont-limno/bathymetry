---
output: pdf_document
header-includes: 
  - \pagenumbering{gobble}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.path = "../figures/", fig.width = 6.5, fig.height = 4.5)
# setwd("figures")
source("../scripts/99_utils.R")
```

```{r 00_map, echo=FALSE, message=FALSE, eval=TRUE, warning=FALSE, results='hide'}
study_bbox    <- st_read("../data/gis.gpkg", "study_bbox", quiet = TRUE)
dt            <- st_read("../data/gis.gpkg", "dt", quiet = TRUE)
max_depth <- dt$lake_maxdepth_m
dt <- dt %>%
  mutate(lake_maxdepth_m = round(lake_maxdepth_m, 2)) %>%
  mutate(maxdepth_class = 
           smart_cut(lake_maxdepth_m, c(10, 30, 70, 200, max(max_depth)), 
                     brackets = NULL, sep = " - ")
         ) %>% # unique(dt$maxdepth_class)
  dplyr::filter(!is.na(maxdepth_class))
states_all    <- st_read("../data/gis.gpkg", "states_all", quiet = TRUE)
states_focal  <- st_read("../data/gis.gpkg", "states_focal", quiet = TRUE)
hu4_focal     <- st_read("../data/gis.gpkg", "hu4s_focal_simple", quiet = TRUE)
hu4_focal     <- st_crop(st_transform(
  lwgeom::st_make_valid(hu4_focal), st_crs(study_bbox)), 
  study_bbox)

gg_states <- 
  ggplot() + 
    geom_sf(data = study_bbox[2,], alpha = 1, size = 0.6, 
          color = "black", fill = "#1D9DCF") +
    geom_sf(data = states_all, fill = "gray", color = "black", size = 0.3) +
    # geom_sf(data = outline, color = "black", alpha = 0, size = 0.8) +
    # geom_sf(data = hu4, fill = "grey") +
    geom_sf(data = states_focal, fill = "white", color = "black", size = 0.4) + 
    geom_sf(data = dt, aes(color = maxdepth_class), size = 0.3, alpha = 0) +
    scale_color_manual(values = viridisLite::viridis(5)) +
    geom_sf(data = dplyr::filter(dt, lake_maxdepth_m < 10),
            aes(color = maxdepth_class), size = 0.3, alpha = 0.8) +
    geom_sf(data = dplyr::filter(dt, lake_maxdepth_m > 10), 
            aes(color = maxdepth_class), size = 0.3, alpha = 0.8) +
    labs(color = "Max depth (m)") +
    coord_sf(datum =  NA) +
    theme_void()

gg_states

```

```{r 00_map_state, echo=FALSE, message=FALSE, eval=TRUE, warning=FALSE, results='hide'}
# proportion of lakes > 4ha with max depth by state
lg <- lagosus_load("locus")
dt <- read.csv("../data/lagosus_depth.csv", stringsAsFactors = FALSE)

dt_plot <- dplyr::select(lg$locus$locus_information, 
                         -contains("decdeg"), 
                         -contains("states"), 
                         -contains("gnis")) %>%
  distinct(lagoslakeid, .keep_all = TRUE) %>%
  left_join(dt, by = "lagoslakeid") %>%
  dplyr::filter(lake_waterarea_ha >= 4) %>%
  group_by(lake_centroidstate) %>%
  summarize(prop_maxdepth = mean(!is.na(lake_maxdepth_m))) %>%
  arrange(desc(prop_maxdepth)) %>%
  left_join(dplyr::filter(
    dplyr::select(states_all, postal, iso_a2), iso_a2 == "US"), 
            by = c("lake_centroidstate" = "postal")) %>%
  dplyr::filter(!is.na(prop_maxdepth))
st_geometry(dt_plot) <- dt_plot$geom
  
# add text labels of proportions

ggplot() + 
  geom_sf(data = dt_plot, aes(fill = prop_maxdepth)) + 
  geom_sf_text(data = dt_plot, 
               aes(label = round(prop_maxdepth, 2)), 
               size = 2.5) +
  labs(fill = "") +
  coord_sf(datum = NA) + theme_void()

```
