---
output: pdf_document
header-includes: 
  - \pagenumbering{gobble}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.path = "../figures/", fig.width = 6.5, fig.height = 4.5)
# setwd("figures")
source("../scripts/99_utils.R")
```


```{r 02_depth_model_grid_resid, echo=FALSE, message=FALSE, eval=TRUE, warning=FALSE, results='hide'}

lgus <- read.csv("../data/lagosus_depth_predictors.csv", 
                 stringsAsFactors = FALSE) %>%
  mutate(lagoslakeid = as.character(lagoslakeid)) %>%
  dplyr::select(-lake_maxdepth_m) %>%
  distinct(lagoslakeid, .keep_all = TRUE)
dt   <- readRDS("../data/01_depth_model/depth_grid.rds") %>%
  mutate(lagoslakeid = as.character(lagoslakeid)) %>%
  left_join(lgus, by = "lagoslakeid")

ggplot(data = dt) + 
  geom_density(aes(x = resid, fill = shape_class)) +
  geom_vline(aes(xintercept = 0)) +
  facet_wrap(~ model)

ggplot(data = dt) + 
  geom_density(aes(x = resid, fill = reservoir_class)) +
  geom_vline(aes(xintercept = 0)) +
  facet_wrap(~ model)
```

```{r 02_depth_model_fitted, echo=FALSE, message=FALSE, eval=TRUE, warning=FALSE, results='hide'}
dt <- readRDS("../data/01_depth_model/depth_model.rds")

gg_noshape <- ggplot() +
  geom_point(data = dplyr::filter(dt$no_shape, shape_class == "convex"),
             aes(y = lake_maxdepth_m, x = fitted_values, color = shape_class),
             alpha = 0.3) +
  geom_point(data = dplyr::filter(dt$no_shape, shape_class == "concave"),
             aes(y = lake_maxdepth_m, x = fitted_values, color = shape_class),
             alpha = 0.3) +
  geom_abline(slope = 1, intercept = 0) +
  ylab("Measured max depth") + xlab("Predicted max depth") +
  ylim(0, 80) + xlim(0, 80) +
  labs(color = "") +
  ggtitle("Max depth ~ Lake Area + Buffer slope")
  # theme(legend.position = "none")

gg_shape <- ggplot() +
  geom_point(data = dplyr::filter(dt$shape, shape_class == "convex"),
             aes(y = lake_maxdepth_m, x = fitted_values, color = shape_class),
             alpha = 0.3) +
  geom_point(data = dplyr::filter(dt$shape, shape_class == "concave"),
             aes(y = lake_maxdepth_m, x = fitted_values, color = shape_class),
             alpha = 0.3) +
  geom_abline(slope = 1, intercept = 0) +
  ylab("Measured max depth") + xlab("Predicted max depth") +
  ylim(0, 80) + xlim(0, 80) +
  labs(color = "") +
  ggtitle("Max depth ~ Lake Area + Buffer slope + Shape class")

legend <- get_legend(
  # create some space to the left of the legend
  gg_noshape + theme(#legend.box.margin = margin(0, 0, 0, 12), 
                     legend.direction = "horizontal")
)

theme_opts <- theme(legend.position = "none", 
                    plot.title = element_text(size = 8))
cowplot::plot_grid(gg_noshape + theme_opts, 
                   gg_shape + theme_opts,
                   legend, 
                   rel_heights = c(1, 0.1)
                   )

```

```{r 02_depth_model_resid, echo=FALSE, message=FALSE, eval=TRUE, warning=FALSE, results='hide'}
# residual = observed - predicted
# positive value = underprediction
# negative value = overprediction

ggplot() +
  geom_boxplot(data = dt$no_shape, aes(y = resid, x = shape_class),
               outlier.shape = NA) +
  ylim(-20, 20)
```

```{r 02_depth_oliver, echo=FALSE, message=FALSE, eval=TRUE, warning=FALSE, results='hide', fig.height=3.4}
# setwd("figures")
oliver2015 <- LAGOSNE::lagos_load_oliver_2015() %>%
  mutate(lake_maxdepth_m_oliver = zmaxpredict)
dt <- readRDS("../data/01_depth_model/oliver_model.rds")

rmse_group <- group_by(dt$test, hu4_zoneid) %>%
  summarize(r_rmse = yardstick::rmse_vec(
    exp(lake_maxdepth_m), 
    exp(lake_maxdepth_m_predicted)) / mean(lake_maxdepth_m))
hu4_gis <- st_read("../data/gis.gpkg", layer = "hu4s_focal_simple") %>%
# ggplot() + 
#   geom_sf(data = hu4_gis) +
#   geom_sf_text(data = hu4_gis, aes(label = hu4_zoneid))
  left_join(rmse_group) %>%
  dplyr::filter(!is.na(r_rmse) & r_rmse != Inf & r_rmse < 12)
ggplot() +
  geom_sf(data = hu4_gis, aes(fill = r_rmse))

## predicted vs obs
ggplot(data = dt$test) + 
  geom_point(aes(x = lake_maxdepth_m_predicted, 
                 y = lake_maxdepth_m)) +
  geom_abline(aes(slope = 1, intercept = 0))

## calculate metrics
gridExtra::grid.arrange(gridExtra::tableGrob(
bind_rows(yardstick::rmse(dt$test, 
                          exp(lake_maxdepth_m), exp(lake_maxdepth_m_predicted)), 
          yardstick::rsq(dt$test,
                         exp(lake_maxdepth_m),
                         exp(lake_maxdepth_m_predicted)))))

## replication vs oliver
# dt$test <- dt$test %>%
#   left_join(dplyr::select(dplyr::mutate(oliver2015, lagoslakeid = as.character(lagoslakeid)), lagoslakeid,
#                           lake_maxdepth_m_oliver))
# ggplot(data = dt$test) + 
#   geom_point(aes(x = exp(lake_maxdepth_m_predicted), 
#                  y = lake_maxdepth_m_oliver)) +
#   geom_abline(aes(slope = 1, intercept = 0))

cowplot::plot_grid(
  ggplot(data = oliver2015) +
    geom_point(aes(x = zmaxpredict, y = zmaxobs)) +
    geom_abline(aes(slope = 1, intercept = 0)), 
  ggplot(data = oliver2015) +
    geom_point(aes(x = log(zmaxpredict), y = log(zmaxobs))) +
    geom_abline(aes(slope = 1, intercept = 0))
)
```
