---
output: pdf_document
header-includes: 
  - \pagenumbering{gobble}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.path = "../figures/", fig.width = 6.5, fig.height = 4.5)
# setwd("figures")
source("../scripts/99_utils.R")
```

```{r depth_model_metrics, echo=FALSE, message=FALSE, eval=TRUE, warning=FALSE, results='hide', fig.height=3, fig.width=4.5}
dt_metrics <- readRDS("../data/01_depth_model/depth_grid_metrics.rds") %>%
  mutate_if(is.numeric, function(x) as.character(round(x, 2))) %>%
  mutate(rsq = as.numeric(rsq)) %>%
  mutate(rsq = case_when(
    as.character(model) == "theta_true_true" ~ NA_real_,
    TRUE ~ rsq)) %>%
  mutate(rmse = case_when(
    as.character(model) == "theta_true_true" ~ "-",
    TRUE ~ rmse)) %>%
  mutate(model = gsub("theta_", "", model)) %>%
  mutate(model = gsub("false", "proxy", model)) %>%
  tidyr::separate(model, c("slope", "distance")) %>%
  dplyr::select(slope, distance, everything(), -.estimator)

ggplot(data = dt_metrics, 
                    aes(x = reorder(slope, desc(slope)), y = distance, 
                        fill = rsq)) +
  geom_tile() +
  scale_fill_viridis_c(begin = 0.4, end = 0.7, na.value = "transparent") +
  scale_x_discrete(limits = rev(levels(dt_metrics$slope)), 
                   position = "top") +
  geom_text(aes(label = rmse), vjust = .5, fontface  = "bold", alpha = 1) +
  xlab("slope") +
  cowplot::theme_cowplot() +
  theme(axis.line = element_blank())
```

```{r 02_depth_model_grid_resid, echo=FALSE, message=FALSE, eval=TRUE, warning=FALSE, results='hide'}

lgus <- read.csv("../data/lagosus_depth_predictors.csv", 
                 stringsAsFactors = FALSE) %>%
  mutate(lagoslakeid = as.character(lagoslakeid)) %>%
  dplyr::select(-lake_maxdepth_m) %>%
  distinct(lagoslakeid, .keep_all = TRUE)
dt   <- readRDS("../data/01_depth_model/depth_grid.rds") %>%
  mutate(lagoslakeid = as.character(lagoslakeid)) %>%
  mutate(resid = case_when(theta == "theta_true_true" ~ NA_real_, 
                           TRUE ~ resid)) %>%
  mutate(theta = factor(theta, levels = c("theta_true_true", "theta_true_false", 
                                  "theta_false_true", "theta_false_false"))) %>%
  left_join(lgus, by = "lagoslakeid")

gg_shape <- ggplot(data = dt) + 
  geom_density(aes(x = resid, fill = shape_class), alpha = 0.75, adjust = 1.3) +
  geom_vline(aes(xintercept = 0), linetype = "dashed") +
  facet_wrap(~ theta) + 
    theme(legend.position = "bottom",
        strip.background = element_blank(), 
        strip.text = element_blank(),
        plot.margin = unit(c(1.2,0.2,0.2,0.2), "cm"))  +
  guides(fill = guide_legend(nrow = 2))

gg_shape <- ggdraw(gg_shape)  +
  # draw_label("proxy", x = 0.83, y = 0.32, angle = 270, size = 10) +
  # draw_label("true", x = 0.83, y = 0.65, angle = 270, size = 10) +
  # draw_label("slope", x = 0.93, y = 0.5, size = 10, angle = 270) +
  draw_label("proxy", x = 0.7, y = 0.89, size = 10) +
  draw_label("true", x = 0.3, y = 0.89, size = 10) +
  draw_label("distance", x = 0.5, y = 0.94, size = 10)# +
  #draw_label("Shape class", x = 0.5, y = 0.98, size = 10, fontface = "bold")


gg_reservoir <- ggplot(data = dt) + 
  geom_density(aes(x = resid, fill = reservoir_class), alpha = 0.75, adjust = 1.3) +
  geom_vline(aes(xintercept = 0), linetype = "dashed") +
  facet_wrap(~ theta) +
  theme(legend.position = "bottom",
        strip.background = element_blank(), 
        strip.text = element_blank(),
        axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        plot.margin = unit(c(1.2,1.2,0.2,0.2), "cm")) +
  guides(fill = guide_legend(nrow = 2))

gg_reservoir <- ggdraw(gg_reservoir) +
  draw_label("proxy", x = 0.83, y = 0.44, angle = 270, size = 10) +
  draw_label("true", x = 0.83, y = 0.77, angle = 270, size = 10) +
  draw_label("slope", x = 0.93, y = 0.62, size = 10, angle = 270) +
  draw_label("proxy", x = 0.7, y = 0.89, size = 10) +
  draw_label("true", x = 0.3, y = 0.89, size = 10) +
  draw_label("distance", x = 0.5, y = 0.94, size = 10)# +
  # draw_label("Reservoir class", x = 0.5, y = 0.98, size = 10, fontface = "bold")

cowplot::plot_grid(gg_shape, gg_reservoir, 
                   nrow = 1, rel_widths = c(1, 0.95))
```

```{r 02_depth_model_fitted, echo=FALSE, message=FALSE, eval=TRUE, warning=FALSE, results='hide'}
dt <- readRDS("../data/01_depth_model/depth_model.rds")

gg_noshape <- ggplot() +
  geom_point(data = dplyr::filter(dt$no_shape, shape_class == "convex"),
             aes(y = lake_maxdepth_m, x = fitted_values, color = shape_class),
             alpha = 0.3) +
  geom_point(data = dplyr::filter(dt$no_shape, shape_class == "concave"),
             aes(y = lake_maxdepth_m, x = fitted_values, color = shape_class),
             alpha = 0.3) +
  geom_abline(slope = 1, intercept = 0) +
  ylab("Measured max depth") + xlab("Predicted max depth") +
  ylim(0, 80) + xlim(0, 80) +
  labs(color = "") +
  ggtitle("Max depth ~ Lake Area + Buffer slope")
  # theme(legend.position = "none")

gg_shape <- ggplot() +
  geom_point(data = dplyr::filter(dt$shape, shape_class == "convex"),
             aes(y = lake_maxdepth_m, x = fitted_values, color = shape_class),
             alpha = 0.3) +
  geom_point(data = dplyr::filter(dt$shape, shape_class == "concave"),
             aes(y = lake_maxdepth_m, x = fitted_values, color = shape_class),
             alpha = 0.3) +
  geom_abline(slope = 1, intercept = 0) +
  ylab("Measured max depth") + xlab("Predicted max depth") +
  ylim(0, 80) + xlim(0, 80) +
  labs(color = "") +
  ggtitle("Max depth ~ Lake Area + Buffer slope + Shape class")

legend <- get_legend(
  # create some space to the left of the legend
  gg_noshape + theme(#legend.box.margin = margin(0, 0, 0, 12), 
                     legend.direction = "horizontal")
)

theme_opts <- theme(legend.position = "none", 
                    plot.title = element_text(size = 8))
cowplot::plot_grid(gg_noshape + theme_opts, 
                   gg_shape + theme_opts,
                   legend, 
                   rel_heights = c(1, 0.1)
                   )

```

```{r 02_depth_model_resid, echo=FALSE, message=FALSE, eval=TRUE, warning=FALSE, results='hide'}
# residual = observed - predicted
# positive value = underprediction
# negative value = overprediction

ggplot() +
  geom_boxplot(data = dt$no_shape, aes(y = resid, x = shape_class),
               outlier.shape = NA) +
  ylim(-20, 20)
```

```{r 02_depth_oliver, echo=FALSE, message=FALSE, eval=TRUE, warning=FALSE, results='hide', fig.height=3.4}
# setwd("figures")
oliver2015 <- LAGOSNE::lagos_load_oliver_2015() %>%
  mutate(lake_maxdepth_m_oliver = zmaxpredict)
dt <- readRDS("../data/01_depth_model/oliver_model.rds")

rmse_group <- group_by(dt$test, hu4_zoneid) %>%
  summarize(r_rmse = yardstick::rmse_vec(
    exp(lake_maxdepth_m), 
    exp(lake_maxdepth_m_predicted)) / mean(lake_maxdepth_m))
hu4_gis <- st_read("../data/gis.gpkg", layer = "hu4s_focal_simple") %>%
# ggplot() + 
#   geom_sf(data = hu4_gis) +
#   geom_sf_text(data = hu4_gis, aes(label = hu4_zoneid))
  left_join(rmse_group) %>%
  dplyr::filter(!is.na(r_rmse) & r_rmse != Inf & r_rmse < 12)
ggplot() +
  geom_sf(data = hu4_gis, aes(fill = r_rmse))

## predicted vs obs
ggplot(data = dt$test) + 
  geom_point(aes(x = lake_maxdepth_m_predicted, 
                 y = lake_maxdepth_m)) +
  geom_abline(aes(slope = 1, intercept = 0))

## calculate metrics
gridExtra::grid.arrange(gridExtra::tableGrob(
bind_rows(yardstick::rmse(dt$test, 
                          exp(lake_maxdepth_m), exp(lake_maxdepth_m_predicted)), 
          yardstick::rsq(dt$test,
                         exp(lake_maxdepth_m),
                         exp(lake_maxdepth_m_predicted)))))

## replication vs oliver
# dt$test <- dt$test %>%
#   left_join(dplyr::select(dplyr::mutate(oliver2015, lagoslakeid = as.character(lagoslakeid)), lagoslakeid,
#                           lake_maxdepth_m_oliver))
# ggplot(data = dt$test) + 
#   geom_point(aes(x = exp(lake_maxdepth_m_predicted), 
#                  y = lake_maxdepth_m_oliver)) +
#   geom_abline(aes(slope = 1, intercept = 0))

cowplot::plot_grid(
  ggplot(data = oliver2015) +
    geom_point(aes(x = zmaxpredict, y = zmaxobs)) +
    geom_abline(aes(slope = 1, intercept = 0)), 
  ggplot(data = oliver2015) +
    geom_point(aes(x = log(zmaxpredict), y = log(zmaxobs))) +
    geom_abline(aes(slope = 1, intercept = 0))
)
```
