---
output: pdf_document
header-includes: 
  - \pagenumbering{gobble}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.path = "../figures/", fig.width = 6.5, fig.height = 4.5)
# setwd("figures")
source("../scripts/99_utils.R")
```

```{r 01_geometry, echo=FALSE, message=FALSE, eval=TRUE, warning=FALSE, results='hide', fig.height=3.5}
# example map of true deepest point versus visual center

# setwd("figures")
dt         <- readRDS("../data/00_bathy_depth/bathy_pnts.rds")
hypso_pred <- read.csv("../data/00_hypso/hypso_predictors.csv", 
                       stringsAsFactors = FALSE) %>%
  mutate(lagoslakeid = as.character(lagoslakeid))
dt <- left_join(dt, dplyr::select(hypso_pred, lagoslakeid, reservoir_class, shape_class), 
                                  by = c("llid" = "lagoslakeid"))

# plot of true deepest versus visual centers
gg_scatter_state <- ggplot(data = st_drop_geometry(dt)) + 
  geom_point(aes(x = dist_deepest, y = dist_viscenter, color = state)) +
  geom_abline(aes(intercept = 0, slope = 1)) +
  xlab("Deepest point distance (m)") +
  ylab("Visual center distance (m)")

gg_scatter_shape <- st_drop_geometry(dt) %>%
  dplyr::filter(!is.na(shape_class)) %>%
  dplyr::filter(dist_viscenter >= dist_deepest) %>%
  dplyr::arrange(desc(factor(shape_class, 
                        levels = c("neither", "concave", "convex")))) %>%
  ggplot(aes(x = dist_deepest, y = dist_viscenter, color = shape_class)) + 
  geom_point() +
  # geom_abline(aes(intercept = 0, slope = 1)) +
  labs(color = "") +
  xlab("Deepest point distance (m)") +
  ylab("Visual center distance (m)")

gg_scatter_reservoir <- st_drop_geometry(dt) %>%
  dplyr::filter(!is.na(reservoir_class)) %>%
  dplyr::filter(dist_viscenter >= dist_deepest) %>%
  ggplot() + 
  geom_point(aes(x = dist_deepest, y = dist_viscenter, color = reservoir_class)) +
  scale_color_discrete(labels = c("NL     ", "Res")) + 
  # geom_abline(aes(intercept = 0, slope = 1)) +
  xlab("Deepest point distance (m)") +
  ylab("Visual center distance (m)")
```

```{r gg_distance, echo=FALSE, message=FALSE, eval=TRUE, warning=FALSE, results='hide', fig.height=3}
gg_distance <- cowplot::plot_grid(gg_scatter_shape + 
                     theme(axis.title.x = element_text(color = "white")), 
                   gg_scatter_reservoir + 
                     labs(color = "") +
                     theme(axis.title.y = element_blank(), 
                           axis.text.y = element_blank()), 
                   rel_widths = c(1, 0.8))
gg_distance

gg_pntrng_deepest <- st_drop_geometry(dt) %>%
    dplyr::filter(!is.na(reservoir_class)) %>%
  group_by(reservoir_class) %>%
  summarize(dist_deepest = list(tibble::enframe(
    quantile(dist_deepest, probs = c(0.05,0.5,0.95), na.rm = TRUE)))) %>% 
  unnest() %>%
  tidyr::spread(name, value) %>%
  ggplot() +
geom_pointrange(aes(x = reservoir_class, y = `50%`, 
                      ymin = `5%`, ymax = `95%`)) +
  ylab("Deepest point distance (m)") + xlab("")

gg_pntrng_viscenter <- st_drop_geometry(dt) %>%
    dplyr::filter(!is.na(reservoir_class)) %>%
  group_by(reservoir_class) %>%
  summarize(dist_viscenter = list(tibble::enframe(
    quantile(dist_viscenter, probs = c(0.05,0.5,0.95), na.rm = TRUE)))) %>% 
  unnest() %>%
  tidyr::spread(name, value) %>%
  ggplot() +
geom_pointrange(aes(x = reservoir_class, y = `50%`, 
                      ymin = `5%`, ymax = `95%`)) +
  ylab("Distance to lake center (m)") + xlab("")

cowplot::plot_grid(gg_pntrng_deepest, gg_pntrng_viscenter)

get_pnt_map <- function(x){
  # x <- 3
  # x <- which(dt$llid == 257862)
  lg_example <- LAGOSUSgis::query_gis(
    "LAGOS_US_All_Lakes_1ha", "lagoslakeid", dt$llid[x])
  crs_example <- st_crs(
    raster(list.files(paste0("../data/", tolower(dt$state[x]), "_bathy"), 
               include.dirs = TRUE, full.names = TRUE)[1])
    )
  st_crs(dt$pnt_deepest)   <- crs_example
  st_crs(dt$pnt_viscenter) <- crs_example
  
  ggplot() + 
    geom_sf(data = lg_example) +
    geom_sf(data = dt$pnt_deepest[x], color = "red") + 
    geom_sf(data = dt$pnt_viscenter[x], color = "green") +
    theme_void()
}

# get_pnt_map(which(dt$llid == 5636))
# get_pnt_map(which(dt$llid == 257862))
cowplot::plot_grid(get_pnt_map(which(dt$llid == 3791)) +
                     ggtitle(3791), 
                   get_pnt_map(which(dt$llid == 2772)) +
                     ggtitle(2772), 
                   get_pnt_map(which(dt$llid == 2655)) +
                     ggtitle(2655), 
                   get_pnt_map(which(dt$llid == 1822)) +
                     ggtitle(1822)
                   )

```

```{r slope-compare, echo=FALSE, message=FALSE, eval=TRUE, warning=FALSE, results='hide', fig.height=3.5}
# compare inlake slope, buffer slope, and online slope
# setwd("figures") 
bp <- readRDS("../data/00_bathy_depth/bathy_pnts.rds")
dt <- read.csv("../data/00_geometry/nearshore.csv", stringsAsFactors = FALSE) %>%
  mutate(llid = as.character(llid))
dt <- left_join(dt, st_drop_geometry(bp), 
                by = "llid") %>%
  dplyr::filter(!is.na(inlake_slope_mean))

# jsta::jheatmap(dt)
# jsta::jheatmap(dt, "inlake_slope.y")
jsta::jheatmap(
  dplyr::select(dt, 
                slope_online_mean,
                inlake_slope_mean,
                slope_mean, 
                slope_mean_ne,
                dist_deepest, 
                dist_viscenter, 
                maxdepth,
                meandepth))

GGally::ggpairs(dplyr::select(dt, 
                inlake_slope_mean, inlake_slope.y,
                slope_online_mean,
                slope_mean, 
                # dist_deepest, 
                # dist_viscenter, 
                maxdepth), 
                progress = FALSE, 
                ) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1), 
          strip.text.y = element_text(angle = 0))

gg_scatter_slope <- function(x, y, dt){
  ggplot(data = dt) + 
    geom_point(aes(UQ(rlang::sym(x)), UQ(rlang::sym(y))))
}

# dt[22,]
# which(dt$inlake_slope.y > 0.4)
# which(dt$inlake_slope.x > 0.4)
dt <- dplyr::filter(dt, inlake_slope.y < 0.4)

cowplot::plot_grid(
  gg_scatter_slope("slope_mean", "maxdepth", dt),
  gg_scatter_slope("inlake_slope.y", "maxdepth", dt), 
  gg_scatter_slope("slope_mean", "inlake_slope.y", dt)
  )
```

```{r buffer-vs-inlake_slope, echo=FALSE, message=FALSE, eval=TRUE, warning=FALSE, results='hide', fig.width=4}
lgus_pred <- read.csv("../data/lagosus_depth_predictors.csv", stringsAsFactors = FALSE) %>%
  mutate(lagoslakeid = as.character(lagoslakeid))
test <- left_join(dt, lgus_pred, by = c("llid" = "lagoslakeid")) %>% 
  dplyr::filter(!is.na(shape_class)) %>%
  dplyr::arrange(desc(factor(shape_class, 
                        levels = c("neither", "concave", "convex"))))

# GGally::ggpairs(dplyr::select(test, matches("class"))) 
                              
gg_slope_shape <- ggplot(data = test, 
                         aes(slope_mean, inlake_slope.y, 
                             color = shape_class)) + 
    geom_point() +
  geom_smooth(data = dplyr::filter(test, shape_class != "neither"), 
              method = "lm", se = FALSE) +
  xlab("Nearshore slope (mean)") +
  ylab("Inlake slope") +
  labs(color = "")

gg_slope_reservoir <- ggplot(data = dplyr::filter(test, !is.na(reservoir_class)), 
                             aes(slope_mean, inlake_slope.y, 
                                 color = reservoir_class)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  xlab("Nearshore slope (mean)") +
  ylab("Inlake slope") +
  labs(color = "")
```

```{r 01_geometry_grid, echo=FALSE, message=FALSE, eval=TRUE, warning=FALSE, results='hide', fig.width=5.5, fig.height=4.2}
theme_opts <- cowplot::theme_cowplot() + 
  theme(legend.position = "none", 
        axis.text = element_text(size = 10), 
        axis.title = element_text(size = 11))

legend_shape     <- cowplot::get_legend(gg_scatter_shape)
legend_reservoir <- cowplot::get_legend(gg_scatter_reservoir + labs(color = ""))
legend_panel     <- cowplot::plot_grid(legend_shape, legend_reservoir, 
                                       ncol = 1, 
                                       align = "hv")

cowplot::plot_grid(
  cowplot::plot_grid(
  cowplot::plot_grid(gg_scatter_shape + 
                       labs(color = "") +
                       # theme(axis.title.x = element_blank()) +
                       theme_opts,
                     gg_scatter_reservoir + 
                       labs(color = "") +
                       theme(#axis.title.x = element_blank(), 
                             axis.title.y = element_blank()) +
                       theme_opts, 
                     ncol = 2),
  cowplot::plot_grid(ggplot() + geom_blank() + 
                       theme_opts + theme(axis.line = element_blank()), 
                     gg_slope_shape +
                       theme_opts,
                     gg_slope_reservoir + 
                       theme(axis.title.y = element_blank()) +
                       theme_opts,
                     ncol = 3, rel_widths = c(0.08, 1, 1)), 
                     rel_widths = c(1, 1), nrow = 2), 
  legend_panel, rel_widths = c(1, 0.12)
)
```
